<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Manager - Game Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/editor/editor.main.css">
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
    <style>
        .console-container {
            background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #1e293b 100%);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            -webkit-backdrop-filter: blur(15px);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .sidebar {
            background: rgba(15, 23, 42, 0.95);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }
        .nav-item {
            transition: all 0.2s ease;
        }
        .nav-item:hover {
            background: rgba(59, 130, 246, 0.1);
            border-left: 3px solid #3b82f6;
        }
        .nav-item.active {
            background: rgba(59, 130, 246, 0.2);
            border-left: 3px solid #3b82f6;
            color: #3b82f6;
        }
        .file-item {
            transition: all 0.15s ease;
        }
        .file-item:hover {
            background: rgba(59, 130, 246, 0.1);
        }
        .file-item.selected {
            background: rgba(59, 130, 246, 0.2);
            border-left: 3px solid #3b82f6;
        }
        .breadcrumb-item {
            transition: all 0.15s ease;
        }
        .breadcrumb-item:hover {
            color: #3b82f6;
        }
        .context-menu {
            background: rgba(30, 41, 59, 0.95);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.4);
        }
        .monaco-editor-container {
            border: 1px solid #334155;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .upload-zone {
            border: 2px dashed #475569;
            transition: all 0.3s ease;
        }
        .upload-zone.dragover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Sidebar Navigation -->
    <div class="fixed left-0 top-0 h-full w-64 sidebar z-50">
        <div class="p-6">
            <div class="flex items-center space-x-3 mb-8">
                <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold">Game Panel</h1>
                    <p class="text-sm text-gray-400">File Management</p>
                </div>
            </div>

            <nav class="space-y-2">
                <a href="/console.html" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-300">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                    </svg>
                    <span>Console</span>
                </a>
                <a href="#" class="nav-item active flex items-center space-x-3 px-4 py-3 rounded-lg">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4l2 2h4a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"/>
                    </svg>
                    <span>Files</span>
                </a>
                <a href="#" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-300">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M4 3a2 2 0 100 4h12a2 2 0 100-4H4z"/>
                        <path fill-rule="evenodd" d="M3 8h14v7a2 2 0 01-2 2H5a2 2 0 01-2-2V8zm5 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" clip-rule="evenodd"/>
                    </svg>
                    <span>Databases</span>
                </a>
                <a href="#" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-300">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                    <span>Backups</span>
                </a>
                <a href="#" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-300">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span>Schedules</span>
                </a>
                <a href="#" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-300">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                    </svg>
                    <span>Users</span>
                </a>
                <a href="#" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-300">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
                    </svg>
                    <span>Settings</span>
                </a>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <div class="ml-64 console-container min-h-screen">
        <!-- Header -->
        <div class="border-b border-gray-700 bg-slate-800/50 backdrop-blur-sm sticky top-0 z-40">
            <div class="px-6 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold">File Manager</h1>
                        <div class="flex items-center space-x-2 mt-1 text-sm text-gray-400">
                            <span class="breadcrumb-item cursor-pointer hover:text-blue-400" onclick="navigateTo('/')">üè† root</span>
                            <span id="breadcrumb-path"></span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <!-- Action buttons -->
                        <button class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-medium flex items-center space-x-2" onclick="showNewFileModal()">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                            </svg>
                            <span>New File</span>
                        </button>
                        <button class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg text-sm font-medium flex items-center space-x-2" onclick="showNewFolderModal()">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"/>
                            </svg>
                            <span>New Folder</span>
                        </button>
                        <button class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg text-sm font-medium flex items-center space-x-2" onclick="showUploadModal()">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
                            </svg>
                            <span>Upload</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- File Explorer -->
        <div class="p-6">
            <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                <!-- File List -->
                <div class="xl:col-span-2">
                    <div class="glass-card rounded-xl overflow-hidden">
                        <div class="bg-slate-800/50 px-4 py-3 border-b border-gray-700">
                            <div class="flex items-center justify-between">
                                <h3 class="font-semibold">Files and Directories</h3>
                                <div class="flex items-center space-x-2">
                                    <button class="text-gray-400 hover:text-white p-1 rounded" onclick="refreshFiles()" title="Refresh">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
                                        </svg>
                                    </button>
                                    <span class="text-sm text-gray-400" id="file-count">0 items</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-4">
                            <div id="file-list" class="space-y-1 max-h-96 overflow-y-auto">
                                <!-- Files will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- File Details/Preview -->
                <div class="space-y-6">
                    <div class="glass-card rounded-xl p-4">
                        <h4 class="font-semibold mb-3">File Information</h4>
                        <div id="file-info" class="space-y-2 text-sm">
                            <p class="text-gray-400">Select a file to view details</p>
                        </div>
                    </div>

                    <div class="glass-card rounded-xl p-4">
                        <h4 class="font-semibold mb-3">Quick Actions</h4>
                        <div class="space-y-2">
                            <button id="edit-btn" class="w-full bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed" disabled onclick="editSelectedFile()">
                                Edit File
                            </button>
                            <button id="download-btn" class="w-full bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed" disabled onclick="downloadSelectedFile()">
                                Download
                            </button>
                            <button id="rename-btn" class="w-full bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded-lg text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed" disabled onclick="renameSelectedFile()">
                                Rename
                            </button>
                            <button id="delete-btn" class="w-full bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed" disabled onclick="deleteSelectedFile()">
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="context-menu" class="fixed hidden z-50 context-menu rounded-lg py-2 min-w-48">
        <a href="#" class="block px-4 py-2 text-sm hover:bg-gray-700" onclick="editFile(contextMenuTarget)">
            <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
            </svg>
            Edit
        </a>
        <a href="#" class="block px-4 py-2 text-sm hover:bg-gray-700" onclick="downloadFile(contextMenuTarget)">
            <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
            </svg>
            Download
        </a>
        <a href="#" class="block px-4 py-2 text-sm hover:bg-gray-700" onclick="renameFile(contextMenuTarget)">
            <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
            </svg>
            Rename
        </a>
        <div class="border-t border-gray-600 my-1"></div>
        <a href="#" class="block px-4 py-2 text-sm text-red-400 hover:bg-gray-700" onclick="deleteFile(contextMenuTarget)">
            <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" clip-rule="evenodd"/>
                <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"/>
            </svg>
            Delete
        </a>
    </div>

    <!-- Modals -->
    <!-- File Editor Modal -->
    <div id="editor-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="glass-card rounded-xl w-11/12 h-5/6 max-w-6xl">
            <div class="bg-slate-800/50 px-6 py-4 border-b border-gray-700 flex items-center justify-between">
                <h3 class="font-semibold" id="editor-title">Edit File</h3>
                <div class="flex items-center space-x-3">
                    <button class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-medium" onclick="saveFile()">
                        Save
                    </button>
                    <button class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg text-sm font-medium" onclick="closeEditor()">
                        Close
                    </button>
                </div>
            </div>
            <div class="p-6 h-full">
                <div id="monaco-editor" class="monaco-editor-container w-full h-full"></div>
            </div>
        </div>
    </div>

    <!-- New File Modal -->
    <div id="new-file-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="glass-card rounded-xl w-96 p-6">
            <h3 class="font-semibold mb-4">Create New File</h3>
            <input type="text" id="new-file-name" placeholder="File name (e.g., config.yml)" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 mb-4">
            <div class="flex space-x-3">
                <button class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-medium flex-1" onclick="createNewFile()">
                    Create
                </button>
                <button class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg text-sm font-medium flex-1" onclick="closeNewFileModal()">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- New Folder Modal -->
    <div id="new-folder-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="glass-card rounded-xl w-96 p-6">
            <h3 class="font-semibold mb-4">Create New Folder</h3>
            <input type="text" id="new-folder-name" placeholder="Folder name" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 mb-4">
            <div class="flex space-x-3">
                <button class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg text-sm font-medium flex-1" onclick="createNewFolder()">
                    Create
                </button>
                <button class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg text-sm font-medium flex-1" onclick="closeNewFolderModal()">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="upload-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="glass-card rounded-xl w-96 p-6">
            <h3 class="font-semibold mb-4">Upload Files</h3>
            <div id="upload-zone" class="upload-zone rounded-lg p-8 text-center mb-4 cursor-pointer" onclick="document.getElementById('file-input').click()">
                <svg class="w-12 h-12 text-gray-400 mx-auto mb-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
                </svg>
                <p class="text-gray-400">Click to select files or drag and drop</p>
            </div>
            <input type="file" id="file-input" multiple class="hidden" title="Select files to upload" onchange="handleFileSelect(event)">
            <div id="selected-files" class="mb-4 max-h-32 overflow-y-auto"></div>
            <div class="flex space-x-3">
                <button class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg text-sm font-medium flex-1" onclick="uploadFiles()">
                    Upload
                </button>
                <button class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg text-sm font-medium flex-1" onclick="closeUploadModal()">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script>
        // File manager state
        let currentPath = '/';
        let selectedFile = null;
        let contextMenuTarget = null;
        let monacoEditor = null;
        let editingFile = null;
        let selectedFiles = [];

        // API Base URL
        const API_BASE = '/api/files';

        // File type icons
        function getFileIcon(file) {
            if (file.type === 'directory') {
                return 'üìÅ';
            }
            
            const ext = file.extension?.toLowerCase();
            const iconMap = {
                'properties': '‚öôÔ∏è',
                'yml': 'üìù',
                'yaml': 'üìù',
                'json': 'üìÑ',
                'jar': '‚òï',
                'log': 'üìú',
                'gz': 'üóúÔ∏è',
                'zip': 'üóúÔ∏è',
                'txt': 'üìÑ',
                'md': 'üìñ',
                'js': 'üìú',
                'html': 'üåê',
                'css': 'üé®',
                'png': 'üñºÔ∏è',
                'jpg': 'üñºÔ∏è',
                'jpeg': 'üñºÔ∏è',
                'gif': 'üñºÔ∏è'
            };
            
            return iconMap[ext] || 'üìÑ';
        }

        // Format file size
        function formatFileSize(bytes) {
            if (!bytes) return '-';
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return (bytes / Math.pow(1024, i)).toFixed(1) + ' ' + sizes[i];
        }

        // Load files for current path
        async function loadFiles(path = currentPath) {
            try {
                const response = await fetch(`${API_BASE}/list?path=${encodeURIComponent(path)}`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load files');
                }
                
                const files = data.files;
                const fileList = document.getElementById('file-list');
                const fileCount = document.getElementById('file-count');
                
                fileList.innerHTML = '';
                fileCount.textContent = `${files.length} items`;
                
                // Add parent directory link if not root
                if (path !== '/') {
                    const parentItem = createFileItem({
                        name: '..',
                        type: 'directory',
                        size: null,
                        modified: '',
                        isParent: true
                    });
                    fileList.appendChild(parentItem);
                }
                
                files.forEach(file => {
                    const fileItem = createFileItem(file);
                    fileList.appendChild(fileItem);
                });
                
                updateBreadcrumb(path);
            } catch (error) {
                console.error('Error loading files:', error);
                alert('Failed to load files: ' + error.message);
            }
        }

        // Create file item element
        function createFileItem(file) {
            const item = document.createElement('div');
            item.className = 'file-item flex items-center justify-between p-3 rounded-lg cursor-pointer';
            item.dataset.filename = file.name;
            item.dataset.type = file.type;
            
            const leftSection = document.createElement('div');
            leftSection.className = 'flex items-center space-x-3';
            
            const icon = document.createElement('span');
            icon.className = 'text-lg';
            icon.textContent = file.isParent ? 'üìÅ' : getFileIcon(file);
            
            const details = document.createElement('div');
            details.innerHTML = `
                <p class="font-medium">${file.name}</p>
                <p class="text-xs text-gray-400">${file.modified}</p>
            `;
            
            leftSection.appendChild(icon);
            leftSection.appendChild(details);
            
            const rightSection = document.createElement('div');
            rightSection.className = 'text-sm text-gray-400';
            rightSection.textContent = formatFileSize(file.size);
            
            item.appendChild(leftSection);
            item.appendChild(rightSection);
            
            // Event listeners
            item.onclick = () => selectFile(item, file);
            item.ondblclick = () => {
                if (file.type === 'directory' || file.isParent) {
                    const newPath = file.isParent ? 
                        currentPath.split('/').slice(0, -1).join('/') || '/' :
                        currentPath === '/' ? `/${file.name}` : `${currentPath}/${file.name}`;
                    navigateTo(newPath);
                } else {
                    editFile(file);
                }
            };
            item.oncontextmenu = (e) => showContextMenu(e, file);
            
            return item;
        }

        // Select file
        function selectFile(element, file) {
            // Remove previous selection
            document.querySelectorAll('.file-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Add selection to current item
            element.classList.add('selected');
            selectedFile = file;
            
            updateFileInfo(file);
            updateActionButtons(file);
        }

        // Update file information panel
        function updateFileInfo(file) {
            const fileInfo = document.getElementById('file-info');
            
            if (file.isParent) {
                fileInfo.innerHTML = '<p class="text-gray-400">Parent directory</p>';
                return;
            }
            
            fileInfo.innerHTML = `
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Name:</span>
                        <span>${file.name}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Type:</span>
                        <span>${file.type === 'directory' ? 'Directory' : 'File'}</span>
                    </div>
                    ${file.size ? `
                    <div class="flex justify-between">
                        <span class="text-gray-400">Size:</span>
                        <span>${formatFileSize(file.size)}</span>
                    </div>
                    ` : ''}
                    <div class="flex justify-between">
                        <span class="text-gray-400">Modified:</span>
                        <span>${file.modified}</span>
                    </div>
                    ${file.extension ? `
                    <div class="flex justify-between">
                        <span class="text-gray-400">Extension:</span>
                        <span>.${file.extension}</span>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        // Update action buttons
        function updateActionButtons(file) {
            const editBtn = document.getElementById('edit-btn');
            const downloadBtn = document.getElementById('download-btn');
            const renameBtn = document.getElementById('rename-btn');
            const deleteBtn = document.getElementById('delete-btn');
            
            const isFile = file.type === 'file' && !file.isParent;
            const canEdit = isFile && ['properties', 'yml', 'yaml', 'json', 'txt', 'log', 'js', 'html', 'css', 'md'].includes(file.extension);
            
            editBtn.disabled = !canEdit;
            downloadBtn.disabled = !isFile;
            renameBtn.disabled = file.isParent;
            deleteBtn.disabled = file.isParent;
        }

        // Navigate to path
        function navigateTo(path) {
            currentPath = path;
            selectedFile = null;
            loadFiles(path);
            
            // Clear selection and reset action buttons
            document.getElementById('file-info').innerHTML = '<p class="text-gray-400">Select a file to view details</p>';
            updateActionButtons({ isParent: true });
        }

        // Update breadcrumb
        function updateBreadcrumb(path) {
            const breadcrumbPath = document.getElementById('breadcrumb-path');
            
            if (path === '/') {
                breadcrumbPath.innerHTML = '';
                return;
            }
            
            const parts = path.split('/').filter(part => part);
            let breadcrumb = '';
            let currentPathBuilder = '';
            
            parts.forEach((part, index) => {
                currentPathBuilder += '/' + part;
                breadcrumb += ` / <span class="breadcrumb-item cursor-pointer hover:text-blue-400" onclick="navigateTo('${currentPathBuilder}')">${part}</span>`;
            });
            
            breadcrumbPath.innerHTML = breadcrumb;
        }

        // Show context menu
        function showContextMenu(event, file) {
            event.preventDefault();
            
            const contextMenu = document.getElementById('context-menu');
            contextMenuTarget = file;
            
            contextMenu.style.left = event.pageX + 'px';
            contextMenu.style.top = event.pageY + 'px';
            contextMenu.classList.remove('hidden');
            
            // Hide context menu when clicking elsewhere
            document.addEventListener('click', hideContextMenu, { once: true });
        }

        // Hide context menu
        function hideContextMenu() {
            document.getElementById('context-menu').classList.add('hidden');
        }

        // File operations
        async function editFile(file) {
            if (file.type !== 'file') return;
            
            // Initialize Monaco Editor
            require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' }});
            require(['vs/editor/editor.main'], async function() {
                const modal = document.getElementById('editor-modal');
                const title = document.getElementById('editor-title');
                
                title.textContent = `Editing: ${file.name}`;
                editingFile = file;
                
                // Get file content from API
                const content = await getFileContent(file);
                
                // Detect language based on file extension
                const language = getLanguageFromExtension(file.extension);
                
                // Create editor
                monacoEditor = monaco.editor.create(document.getElementById('monaco-editor'), {
                    value: content,
                    language: language,
                    theme: 'vs-dark',
                    automaticLayout: true
                });
                
                modal.classList.remove('hidden');
            });
        }

        // Get file content from API
        async function getFileContent(file) {
            try {
                const response = await fetch(`${API_BASE}/read?path=${encodeURIComponent(currentPath === '/' ? `/${file.name}` : `${currentPath}/${file.name}`)}`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to read file');
                }
                
                return data.content;
            } catch (error) {
                console.error('Error reading file:', error);
                return `# Error reading ${file.name}\n# ${error.message}`;
            }
        }

        // Get Monaco language from file extension
        function getLanguageFromExtension(extension) {
            const languageMap = {
                'properties': 'ini',
                'yml': 'yaml',
                'yaml': 'yaml',
                'json': 'json',
                'js': 'javascript',
                'html': 'html',
                'css': 'css',
                'md': 'markdown',
                'txt': 'plaintext',
                'log': 'plaintext'
            };
            
            return languageMap[extension] || 'plaintext';
        }

        // Save file
        async function saveFile() {
            if (!monacoEditor || !editingFile) return;
            
            try {
                const content = monacoEditor.getValue();
                const filePath = currentPath === '/' ? `/${editingFile.name}` : `${currentPath}/${editingFile.name}`;
                
                const response = await fetch(`${API_BASE}/write`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        path: filePath,
                        content: content
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to save file');
                }
                
                alert(`File ${editingFile.name} saved successfully!`);
                closeEditor();
                refreshFiles();
            } catch (error) {
                console.error('Error saving file:', error);
                alert('Failed to save file: ' + error.message);
            }
        }

        // Close editor
        function closeEditor() {
            const modal = document.getElementById('editor-modal');
            modal.classList.add('hidden');
            
            if (monacoEditor) {
                monacoEditor.dispose();
                monacoEditor = null;
            }
            
            editingFile = null;
        }

        // Download file
        function downloadFile(file) {
            if (file.type !== 'file') return;
            
            const filePath = currentPath === '/' ? `/${file.name}` : `${currentPath}/${file.name}`;
            const downloadUrl = `${API_BASE}/download?path=${encodeURIComponent(filePath)}`;
            
            // Create a temporary link and click it
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = file.name;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Rename file
        async function renameFile(file) {
            const newName = prompt(`Enter new name for ${file.name}:`, file.name);
            if (newName && newName !== file.name) {
                try {
                    const oldPath = currentPath === '/' ? `/${file.name}` : `${currentPath}/${file.name}`;
                    const newPath = currentPath === '/' ? `/${newName}` : `${currentPath}/${newName}`;
                    
                    const response = await fetch(`${API_BASE}/rename`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            oldPath: oldPath,
                            newPath: newPath
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.error || 'Failed to rename');
                    }
                    
                    alert(`${file.name} renamed to ${newName}`);
                    refreshFiles();
                } catch (error) {
                    console.error('Error renaming file:', error);
                    alert('Failed to rename: ' + error.message);
                }
            }
        }

        // Delete file
        async function deleteFile(file) {
            if (confirm(`Are you sure you want to delete ${file.name}?`)) {
                try {
                    const filePath = currentPath === '/' ? `/${file.name}` : `${currentPath}/${file.name}`;
                    
                    const response = await fetch(`${API_BASE}/delete?path=${encodeURIComponent(filePath)}`, {
                        method: 'DELETE'
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.error || 'Failed to delete');
                    }
                    
                    alert(`${file.name} deleted successfully!`);
                    refreshFiles();
                } catch (error) {
                    console.error('Error deleting file:', error);
                    alert('Failed to delete: ' + error.message);
                }
            }
        }

        // Selected file operations
        function editSelectedFile() {
            if (selectedFile) editFile(selectedFile);
        }

        function downloadSelectedFile() {
            if (selectedFile) downloadFile(selectedFile);
        }

        function renameSelectedFile() {
            if (selectedFile) renameFile(selectedFile);
        }

        function deleteSelectedFile() {
            if (selectedFile) deleteFile(selectedFile);
        }

        // Modal operations
        function showNewFileModal() {
            document.getElementById('new-file-modal').classList.remove('hidden');
        }

        function closeNewFileModal() {
            document.getElementById('new-file-modal').classList.add('hidden');
            document.getElementById('new-file-name').value = '';
        }

        async function createNewFile() {
            const name = document.getElementById('new-file-name').value.trim();
            if (name) {
                try {
                    const filePath = currentPath === '/' ? `/${name}` : `${currentPath}/${name}`;
                    
                    const response = await fetch(`${API_BASE}/write`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            path: filePath,
                            content: ''
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.error || 'Failed to create file');
                    }
                    
                    alert(`File ${name} created successfully!`);
                    closeNewFileModal();
                    refreshFiles();
                } catch (error) {
                    console.error('Error creating file:', error);
                    alert('Failed to create file: ' + error.message);
                }
            }
        }

        function showNewFolderModal() {
            document.getElementById('new-folder-modal').classList.remove('hidden');
        }

        function closeNewFolderModal() {
            document.getElementById('new-folder-modal').classList.add('hidden');
            document.getElementById('new-folder-name').value = '';
        }

        async function createNewFolder() {
            const name = document.getElementById('new-folder-name').value.trim();
            if (name) {
                try {
                    const folderPath = currentPath === '/' ? `/${name}` : `${currentPath}/${name}`;
                    
                    const response = await fetch(`${API_BASE}/mkdir`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            path: folderPath
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.error || 'Failed to create folder');
                    }
                    
                    alert(`Folder ${name} created successfully!`);
                    closeNewFolderModal();
                    refreshFiles();
                } catch (error) {
                    console.error('Error creating folder:', error);
                    alert('Failed to create folder: ' + error.message);
                }
            }
        }

        function showUploadModal() {
            document.getElementById('upload-modal').classList.remove('hidden');
        }

        function closeUploadModal() {
            document.getElementById('upload-modal').classList.add('hidden');
            selectedFiles = [];
            document.getElementById('selected-files').innerHTML = '';
        }

        function handleFileSelect(event) {
            selectedFiles = Array.from(event.target.files);
            displaySelectedFiles();
        }

        function displaySelectedFiles() {
            const container = document.getElementById('selected-files');
            container.innerHTML = '';
            
            selectedFiles.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-2 bg-gray-700 rounded mb-2';
                item.innerHTML = `
                    <span class="text-sm">${file.name}</span>
                    <button onclick="removeSelectedFile(${index})" class="text-red-400 hover:text-red-300">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                `;
                container.appendChild(item);
            });
        }

        function removeSelectedFile(index) {
            selectedFiles.splice(index, 1);
            displaySelectedFiles();
        }

        function uploadFiles() {
            if (selectedFiles.length === 0) return;
            
            console.log(`Uploading ${selectedFiles.length} files to ${currentPath}`);
            selectedFiles.forEach(file => {
                console.log(`Uploading: ${file.name}`);
            });
            
            alert(`${selectedFiles.length} files uploaded successfully!`);
            closeUploadModal();
            refreshFiles();
        }

        // Refresh files
        function refreshFiles() {
            loadFiles(currentPath);
        }

        // Drag and drop functionality
        function setupDragAndDrop() {
            const uploadZone = document.getElementById('upload-zone');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadZone.addEventListener(eventName, preventDefaults, false);
            });
            
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadZone.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadZone.addEventListener(eventName, unhighlight, false);
            });
            
            uploadZone.addEventListener('drop', handleDrop, false);
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            function highlight() {
                uploadZone.classList.add('dragover');
            }
            
            function unhighlight() {
                uploadZone.classList.remove('dragover');
            }
            
            function handleDrop(e) {
                selectedFiles = Array.from(e.dataTransfer.files);
                displaySelectedFiles();
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadFiles();
            setupDragAndDrop();
        });
    </script>
</body>
</html>
